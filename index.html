<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // CONFIGURACION FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyCmuO4U_fDthWu_vY-ghx9marNtF78_vzM",
          authDomain: "nacimientos2.firebaseapp.com",
          projectId: "nacimientos2",
          storageBucket: "nacimientos2.firebasestorage.app",
          messagingSenderId: "228024131760",
          appId: "1:228024131760:web:8159300ab19043453d9b75"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let allPatients = []; 
        const patientsCollection = collection(db, "pacientes");
        const auditLogsCollection = collection(db, "logs_borrado");
        let patientsListenerUnsubscribe = null; 
        
        // Variables para Gráficos
        let chartEvolutionRN = null; // Renombrado
        let chartType = null;
        let chartTerm = null;
        let chartControl = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Referencias DOM
            const loginView = document.getElementById('login-view');
            const appView = document.getElementById('app-view');
            const loadingView = document.getElementById('loading-view');
            const userEmailDisplay = document.getElementById('user-email');
            
            // Navegación
            const tabs = {
                ingreso: document.getElementById('tab-ingreso'),
                consultas: document.getElementById('tab-consultas'),
                dashboard: document.getElementById('tab-dashboard')
            };
            const views = {
                ingreso: document.getElementById('ingreso-view'),
                consultas: document.getElementById('consultas-view'),
                dashboard: document.getElementById('dashboard-view')
            };

            // Dashboard Inputs
            const dashYearSelect = document.getElementById('dash-year');
            const dashMonthSelect = document.getElementById('dash-month');
            const refreshDashboardBtn = document.getElementById('refresh-dashboard');

            // Forms y Botones
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const ingresoForm = document.getElementById('ingreso-form');
            const searchButton = document.getElementById('search-button');
            const clearSearchButton = document.getElementById('clear-search-button');

            // --- AUTENTICACION ---
            onAuthStateChanged(auth, (user) => {
                loadingView.classList.add('hidden');
                if (user) {
                    currentUser = user;
                    userEmailDisplay.textContent = user.email;
                    loginView.classList.add('hidden');
                    appView.classList.remove('hidden');
                    setupRealtimeListener();
                } else {
                    currentUser = null;
                    allPatients = [];
                    loginView.classList.remove('hidden');
                    appView.classList.add('hidden');
                }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    await signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value);
                    showToast('Bienvenido', 'success');
                } catch (error) { showToast(error.message, 'error'); }
            });

            document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
            
            document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); });
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); signupForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    await createUserWithEmailAndPassword(auth, e.target['signup-email'].value, e.target['signup-password'].value);
                    showToast('Cuenta creada', 'success');
                } catch (error) { showToast(error.message, 'error'); }
            });

            // --- NAVEGACION ---
            function switchTab(target) {
                Object.values(views).forEach(v => v.classList.add('hidden'));
                Object.values(tabs).forEach(t => {
                    t.classList.remove('active');
                    t.classList.add('inactive');
                });

                views[target].classList.remove('hidden');
                tabs[target].classList.add('active');
                tabs[target].classList.remove('inactive');

                if (target === 'consultas') updateTableDefault();
                if (target === 'dashboard') {
                    // Si no hay años cargados, cargarlos
                    if (dashYearSelect.options.length === 0) populateYearFilter();
                    updateDashboard();
                }
            }

            tabs.ingreso.addEventListener('click', () => switchTab('ingreso'));
            tabs.consultas.addEventListener('click', () => switchTab('consultas'));
            tabs.dashboard.addEventListener('click', () => switchTab('dashboard'));

            // --- LOGICA DE DATOS ---
            function setupRealtimeListener() {
                if (patientsListenerUnsubscribe) patientsListenerUnsubscribe();
                patientsListenerUnsubscribe = onSnapshot(patientsCollection, (snapshot) => {
                    allPatients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Ordenar por fecha nacimiento descendente
                    allPatients.sort((a, b) => {
                        const dateA = new Date(a.fecha_nacimiento || 0);
                        const dateB = new Date(b.fecha_nacimiento || 0);
                        return dateB - dateA;
                    });

                    document.getElementById('total-nacimientos').textContent = countCurrentMonthBirths(allPatients);
                    
                    if (!views.dashboard.classList.contains('hidden')) {
                        populateYearFilter(); // Recargar años si entran nuevos datos
                        updateDashboard();
                    }
                    if (!views.consultas.classList.contains('hidden')) updateTableDefault();

                }, (error) => console.error(error));
            }

            function countCurrentMonthBirths(patients) {
                const now = new Date();
                return patients.filter(p => {
                    if (!p.fecha_nacimiento) return false;
                    const d = new Date(p.fecha_nacimiento + "T00:00:00");
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                }).length;
            }

            // --- DASHBOARD LOGIC (MEJORADA) ---

            function populateYearFilter() {
                const years = new Set();
                const currentYear = new Date().getFullYear();
                years.add(currentYear); // Asegurar que el año actual está
                
                allPatients.forEach(p => {
                    if(p.fecha_nacimiento) {
                        years.add(new Date(p.fecha_nacimiento).getFullYear());
                    }
                });

                const sortedYears = Array.from(years).sort((a,b) => b-a);
                const currentVal = dashYearSelect.value;
                
                dashYearSelect.innerHTML = '';
                sortedYears.forEach(y => {
                    const opt = document.createElement('option');
                    opt.value = y;
                    opt.textContent = y;
                    dashYearSelect.appendChild(opt);
                });

                // Mantener selección o default
                if(sortedYears.includes(parseInt(currentVal))) {
                    dashYearSelect.value = currentVal;
                } else {
                    dashYearSelect.value = currentYear;
                }
            }

            function updateDashboard() {
                const selectedYear = parseInt(dashYearSelect.value);
                const selectedMonth = dashMonthSelect.value; // 'all' or '0'-'11'
                
                // 1. FILTRAR DATOS
                const filteredData = allPatients.filter(p => {
                    if (!p.fecha_nacimiento) return false;
                    const d = new Date(p.fecha_nacimiento + "T00:00:00");
                    
                    const matchYear = d.getFullYear() === selectedYear;
                    let matchMonth = true;
                    if(selectedMonth !== 'all') {
                        matchMonth = d.getMonth() === parseInt(selectedMonth);
                    }
                    return matchYear && matchMonth;
                });

                // 2. KPIS
                const total = filteredData.length;
                
                // Cesáreas
                const cesareas = filteredData.filter(p => p.tipo_nacimiento === 'cesarea').length;
                const cesareaPct = total > 0 ? Math.round((cesareas / total) * 100) : 0;

                // Promedio Edad Gestacional (Reemplaza a Peso)
                const egs = filteredData.map(p => parseFloat(p.eg)).filter(e => !isNaN(e) && e > 0);
                const avgEg = egs.length > 0 ? (egs.reduce((a, b) => a + b, 0) / egs.length).toFixed(1) : 0;

                document.getElementById('kpi-total').textContent = total;
                document.getElementById('kpi-cesarea').textContent = `${cesareaPct}%`;
                document.getElementById('kpi-eg-avg').textContent = `${avgEg} sem`;

                // 3. RENDER CHARTS
                renderDestinoChart(filteredData); // NUEVO
                renderDistributionCharts(filteredData);
            }

            // Gráfico EVOLUCION / DESTINO (NUEVO)
            function renderDestinoChart(data) {
                const ctx = document.getElementById('chart-evolution-rn').getContext('2d');
                
                let counts = {
                    'internacion_conjunta': 0,
                    'utin': 0,
                    'obito': 0
                };

                data.forEach(p => {
                    if(p.evolucion && counts.hasOwnProperty(p.evolucion)) {
                        counts[p.evolucion]++;
                    }
                });

                if (chartEvolutionRN) chartEvolutionRN.destroy();
                chartEvolutionRN = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Internación Conjunta', 'UTIN', 'Óbito'],
                        datasets: [{
                            label: 'Cantidad',
                            data: [counts['internacion_conjunta'], counts['utin'], counts['obito']],
                            backgroundColor: [
                                '#10b981', // Verde para conjunta
                                '#f59e0b', // Naranja para UTIN
                                '#ef4444'  // Rojo para Obito
                            ],
                            borderRadius: 4
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }, // Ocultar leyenda porque los ejes ya explican
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                        }
                    }
                });
            }

            function renderDistributionCharts(data) {
                // --- Chart 2: Tipo Nacimiento ---
                const types = { 'parto': 0, 'cesarea': 0 };
                data.forEach(p => {
                    if(p.tipo_nacimiento === 'parto') types['parto']++;
                    else if(p.tipo_nacimiento === 'cesarea') types['cesarea']++;
                });

                const ctxType = document.getElementById('chart-type').getContext('2d');
                if (chartType) chartType.destroy();
                chartType = new Chart(ctxType, {
                    type: 'doughnut',
                    data: {
                        labels: ['Parto Vaginal', 'Cesárea'],
                        datasets: [{
                            data: [types['parto'], types['cesarea']],
                            backgroundColor: ['#10b981', '#f97316']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // --- Chart 3: Término vs Pretérmino ---
                let termino = 0, preterm = 0;
                data.forEach(p => {
                    const eg = parseFloat(p.eg);
                    if(eg) {
                        if(eg < 37) preterm++;
                        else termino++;
                    }
                });

                const ctxTerm = document.getElementById('chart-term').getContext('2d');
                if (chartTerm) chartTerm.destroy();
                chartTerm = new Chart(ctxTerm, {
                    type: 'pie',
                    data: {
                        labels: ['Término (>=37s)', 'Pretérmino (<37s)'],
                        datasets: [{
                            data: [termino, preterm],
                            backgroundColor: ['#6366f1', '#ef4444']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // --- Chart 4: Controlada ---
                let si = 0, no = 0;
                data.forEach(p => {
                   if(p.controlada) si++; else no++;
                });
                
                const ctxControl = document.getElementById('chart-control').getContext('2d');
                if (chartControl) chartControl.destroy();
                chartControl = new Chart(ctxControl, {
                    type: 'pie',
                    data: {
                        labels: ['Controlada', 'No Controlada'],
                        datasets: [{
                            data: [si, no],
                            backgroundColor: ['#0ea5e9', '#94a3b8']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
            
            // Listeners para filtros
            dashYearSelect.addEventListener('change', updateDashboard);
            dashMonthSelect.addEventListener('change', updateDashboard);
            refreshDashboardBtn.addEventListener('click', () => {
                updateDashboard();
                showToast("Dashboard actualizado", "success");
            });

            // --- INGRESO ---
            ingresoForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) return showToast('Debes iniciar sesión', 'error');

                const btn = ingresoForm.querySelector('button[type="submit"]');
                btn.disabled = true; btn.textContent = 'Guardando...';

                try {
                    const formData = new FormData(ingresoForm);
                    const data = Object.fromEntries(formData.entries());
                    
                    data.controlada = document.getElementById('controlada').checked;
                    data.diagnostico = Array.from(document.getElementById('diagnostico').selectedOptions).map(o => o.value);
                    data.antPatologicos = Array.from(document.getElementById('antPatologicos').selectedOptions).map(o => o.value);
                    
                    data.createdAt = Timestamp.now();
                    data.createdBy = currentUser.email;

                    await addDoc(patientsCollection, data);
                    showToast('Guardado correctamente', 'success');
                    ingresoForm.reset();
                    document.querySelectorAll('details').forEach(d => d.open = false);
                } catch (err) {
                    console.error(err);
                    showToast('Error al guardar', 'error');
                } finally {
                    btn.disabled = false; btn.textContent = 'Guardar Paciente';
                }
            });

            document.getElementById('diagnostico').addEventListener('change', (e) => {
                const vals = Array.from(e.target.selectedOptions).map(o => o.value);
                const wrap = document.getElementById('diagnostico_otros_wrapper');
                const input = document.getElementById('diagnostico_otros');
                if(vals.includes('otros')) { wrap.classList.remove('hidden'); input.required = true; }
                else { wrap.classList.add('hidden'); input.required = false; }
            });

            // --- CONSULTAS ---
            function updateTableDefault() {
                // MODIFICADO: Muestra solo los 3 pacientes más recientes (en las posiciones 0, 1, 2 después de ordenar)
                renderTable(allPatients.slice(0, 3)); 
            }

            searchButton.addEventListener('click', () => {
                const apellido = document.getElementById('search-apellido').value.toLowerCase();
                const fDesde = document.getElementById('search-fecha-desde').value;
                const fHasta = document.getElementById('search-fecha-hasta').value;

                let filtered = allPatients.filter(p => {
                    let match = true;
                    if(apellido && (!p.apellido || !p.apellido.toLowerCase().includes(apellido))) match = false;
                    if(fDesde && p.fecha_nacimiento < fDesde) match = false;
                    if(fHasta && p.fecha_nacimiento > fHasta) match = false;
                    return match;
                });
                renderTable(filtered);
            });

            document.getElementById('clear-search-button').addEventListener('click', () => {
                document.getElementById('search-apellido').value = '';
                document.getElementById('search-fecha-desde').value = '';
                document.getElementById('search-fecha-hasta').value = '';
                updateTableDefault();
            });

            function renderTable(data) {
                const tbody = document.getElementById('pacientes-tbody');
                tbody.innerHTML = '';
                if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">No hay datos</td></tr>'; return; }

                data.forEach(p => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 border-b';
                    row.innerHTML = `
                        <td class="p-4">${p.apellido || ''}</td>
                        <td class="p-4">${p.nombre || ''}</td>
                        <td class="p-4">${formatDate(p.fecha_nacimiento)}</td>
                        <td class="p-4 text-sm text-gray-500 truncate max-w-xs">${p.diagnostico ? p.diagnostico.join(', ') : ''}</td>
                        <td class="p-4 text-right">
                            <button class="btn-danger" onclick="window.deletePatient('${p.id}')">Borrar</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            window.deletePatient = async (id) => {
                if(!confirm("¿Borrar paciente?")) return;
                try {
                    await deleteDoc(doc(db, "pacientes", id));
                    showToast("Borrado", "success");
                } catch(e) { showToast("Error al borrar", "error"); }
            };

            function formatDate(str) {
                if(!str) return '-';
                const [y, m, d] = str.split('-');
                return `${d}/${m}/${y}`;
            }

            function showToast(msg, type) {
                const t = document.getElementById('toast');
                t.textContent = msg; t.className = type; t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            }
            
            switchTab('ingreso');
        });
    </script>
