<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Nacimientos + Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- ESTILOS (Originales + Dashboard) --- */
        body { font-family: 'Inter', sans-serif; }
        .title-text { color: #2563eb; }

        /* Botones */
        .btn-primary {
            background-color: #2563eb; color: white; padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; font-weight: bold; transition: background-color 0.3s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover { background-color: #1d4ed8; }

        .btn-secondary {
            background-color: #f3f4f6; color: #374151; padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; font-weight: 600; border: 1px solid #d1d5db;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover { background-color: #e5e7eb; }

        /* Botones pequeños de acción */
        .btn-danger, .btn-edit, .btn-share {
            color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem;
            border-radius: 0.375rem; font-weight: 600; transition: background-color 0.3s;
        }
        .btn-danger { background-color: #dc2626; } .btn-danger:hover { background-color: #b91c1c; }
        .btn-edit { background-color: #f97316; } .btn-edit:hover { background-color: #ea580c; }
        .btn-share { background-color: #10b981; } .btn-share:hover { background-color: #059669; }

        /* Formularios */
        .form-input {
            width: 100%; padding: 0.75rem; border: 1px solid #d1d5db;
            border-radius: 0.5rem; transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-input:focus {
            border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); outline: none;
        }

        /* Pestañas */
        .tab-btn {
            padding: 1rem 1.5rem; font-weight: 600; border-radius: 0.5rem 0.5rem 0 0;
            transition: background-color 0.3s, color 0.3s;
        }
        .tab-btn.active {
            background-color: white; color: #2563eb; box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
            border-bottom: 2px solid white; margin-bottom: -1px; z-index: 10;
        }
        .tab-btn.inactive { background-color: transparent; color: #6b7280; }
        .tab-btn.inactive:hover { background-color: #ebf8ff; color: #2563eb; }

        /* Detalles y Switch */
        details { border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 1rem; }
        details summary { font-weight: 600; padding: 1rem; cursor: pointer; background-color: #f9fafb; border-radius: 0.5rem 0.5rem 0 0; }
        details[open] summary { border-bottom: 1px solid #e5e7eb; }
        details div { padding: 1.5rem; background-color: white; }

        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2563eb; }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Toast */
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 1rem 2rem; border-radius: 0.5rem; color: white; font-weight: 600;
            z-index: 100; opacity: 0; transition: opacity 0.5s, transform 0.5s; visibility: hidden;
        }
        #toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
        #toast.success { background-color: #16a34a; }
        #toast.error { background-color: #dc2626; }
        
        /* Dashboard Cards */
        .dash-card {
            background: white; border-radius: 0.5rem; padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            display: flex; flex-direction: column;
        }
        .dash-stat-value { font-size: 2rem; font-weight: 800; color: #2563eb; }
        .dash-stat-label { font-size: 0.875rem; color: #6b7280; font-weight: 500; }
        
        /* Selects del Dashboard */
        .dash-select {
            padding: 0.5rem 2rem 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            background-color: white;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            cursor: pointer;
        }
    </style>
</head>

<body class="bg-sky-50 text-gray-900">

    <div id="loading-view" class="flex items-center justify-center min-h-screen">
        <div class="text-xl font-semibold title-text animate-pulse">Cargando aplicación...</div>
    </div>

    <div id="login-view" class="hidden min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-xl">
            <h1 class="text-3xl font-bold text-center title-text mb-8">Registro de Nacimientos</h1>
            
            <form id="login-form">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Iniciar Sesión</h2>
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" name="email" class="form-input mt-1" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                    <input type="password" id="password" name="password" class="form-input mt-1" required>
                </div>
                <button type="submit" class="btn-primary w-full">Ingresar</button>
                <p class="text-sm text-center mt-4">
                    ¿No tienes cuenta? 
                    <a href="#" id="show-signup" class="font-medium text-blue-600 hover:text-blue-500">Regístrate aquí</a>
                </p>
            </form>

            <form id="signup-form" class="hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Crear Cuenta</h2>
                <div class="mb-4">
                    <label for="signup-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="signup-email" name="signup-email" class="form-input mt-1" required>
                </div>
                <div class="mb-6">
                    <label for="signup-password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                    <input type="password" id="signup-password" name="signup-password" class="form-input mt-1" required>
                </div>
                <button type="submit" class="btn-primary w-full">Registrarse</button>
                <p class="text-sm text-center mt-4">
                    ¿Ya tienes cuenta? 
                    <a href="#" id="show-login" class="font-medium text-blue-600 hover:text-blue-500">Inicia sesión</a>
                </p>
            </form>
        </div>
    </div>

    <div id="app-view" class="hidden">
        
        <header class="bg-blue-600 text-white shadow-lg p-4">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold flex items-center gap-2">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    Registro de Nacimientos
                </h1>
                <div class="flex items-center">
                    <span id="user-email" class="text-sm mr-4 hidden md:block opacity-90"></span>
                    <button id="logout-button" class="bg-white text-blue-600 font-bold py-2 px-4 rounded-lg shadow hover:bg-blue-100 transition text-sm">
                        Salir
                    </button>
                </div>
            </div>
        </header>

        <nav class="container mx-auto px-4 sm:px-8 mt-8">
            <div class="flex gap-x-2 border-b border-gray-200 bg-gray-100 rounded-t-lg p-2 overflow-x-auto">
                <button id="tab-ingreso" class="tab-btn active whitespace-nowrap">
                    Ingreso
                </button>
                <button id="tab-consultas" class="tab-btn inactive whitespace-nowrap">
                    Consultas
                </button>
                <button id="tab-dashboard" class="tab-btn inactive whitespace-nowrap flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    Tablero Estadístico
                </button>
            </div>
        </nav>

        <main class="container mx-auto px-4 sm:px-8 mb-12">
            
            <div id="ingreso-view" class="p-8 bg-white shadow-lg rounded-b-lg">
                <h2 class="text-2xl font-semibold title-text mb-6">Nuevo Ingreso de Paciente</h2>
                
                <form id="ingreso-form" class="space-y-6">
                    <h3 class="text-lg font-semibold title-text border-b pb-2">Datos del Paciente</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div><label for="apellido" class="block text-sm font-medium text-gray-700">Apellido</label><input type="text" id="apellido" name="apellido" class="form-input mt-1" required></div>
                        <div><label for="nombre" class="block text-sm font-medium text-gray-700">Nombre</label><input type="text" id="nombre" name="nombre" class="form-input mt-1" required></div>
                        <div><label for="fecha_nacimiento" class="block text-sm font-medium text-gray-700">Fecha de Nacimiento</label><input type="date" id="fecha_nacimiento" name="fecha_nacimiento" class="form-input mt-1" required></div>
                        <div><label for="hora_nacimiento" class="block text-sm font-medium text-gray-700">Hora Nac.</label><input type="time" id="hora_nacimiento" name="hora_nacimiento" class="form-input mt-1" required></div>
                    </div>
                    
                    <hr>
                    <h3 class="text-lg font-semibold title-text border-b pb-2">Datos Maternos</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        <div><label for="edad_materna" class="block text-sm font-medium text-gray-700">Edad Materna</label><input type="number" id="edad_materna" name="edad_materna" class="form-input mt-1" min="10"></div>
                        <div><label for="g" class="block text-sm font-medium text-gray-700">G</label><input type="number" id="g" name="g" class="form-input mt-1" min="0" max="15"></div>
                        <div><label for="p" class="block text-sm font-medium text-gray-700">P</label><input type="number" id="p" name="p" class="form-input mt-1" min="0" max="15"></div>
                        <div><label for="a" class="block text-sm font-medium text-gray-700">A</label><input type="number" id="a" name="a" class="form-input mt-1" min="0" max="15"></div>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-6 items-center">
                        <div class="flex flex-wrap items-center gap-x-6 gap-y-2">
                            <div class="flex items-center space-x-4">
                                <label for="controlada" class="block text-sm font-medium text-gray-700">Controlada</label>
                                <label class="switch"><input type="checkbox" id="controlada" name="controlada"><span class="slider"></span></label>
                            </div>
                            <div class="flex-1 min-w-[150px]">
                                <label for="num_controles" class="block text-sm font-medium text-gray-700">N° de Controles</label>
                                <input type="number" id="num_controles" name="num_controles" class="form-input mt-1" min="0" max="99">
                            </div>
                        </div>
                    </div>

                    <details>
                        <summary>Serologías Maternas</summary>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div><label class="block text-sm font-medium text-gray-700">VDRL</label><div class="grid grid-cols-3 gap-2 mt-1"><input type="date" name="vdrl_fecha" class="form-input col-span-2"><select name="vdrl_resultado" class="form-input"><option value="-">-</option><option value="+">+</option></select></div></div>
                            <div><label class="block text-sm font-medium text-gray-700">HIV</label><div class="grid grid-cols-3 gap-2 mt-1"><input type="date" name="hiv_fecha" class="form-input col-span-2"><select name="hiv_resultado" class="form-input"><option value="-">-</option><option value="+">+</option></select></div></div>
                            <div><label class="block text-sm font-medium text-gray-700">Chagas</label><div class="grid grid-cols-3 gap-2 mt-1"><input type="date" name="chagas_fecha" class="form-input col-span-2"><select name="chagas_resultado" class="form-input"><option value="-">-</option><option value="+">+</option></select></div></div>
                            <div><label class="block text-sm font-medium text-gray-700">HBV</label><div class="grid grid-cols-3 gap-2 mt-1"><input type="date" name="hbv_fecha" class="form-input col-span-2"><select name="hbv_resultado" class="form-input"><option value="-">-</option><option value="+">+</option></select></div></div>
                            <div><label class="block text-sm font-medium text-gray-700">Toxoplasmosis</label><div class="grid grid-cols-3 gap-2 mt-1"><input type="date" name="toxo_fecha" class="form-input col-span-2"><select name="toxo_resultado" class="form-input"><option value="-">-</option><option value="+">+</option></select></div></div>
                            <div><label class="block text-sm font-medium text-gray-700">CMV</label><div class="grid grid-cols-3 gap-2 mt-1"><input type="date" name="cmv_fecha" class="form-input col-span-2"><select name="cmv_resultado" class="form-input"><option value="-">-</option><option value="+">+</option></select></div></div>
                            <div class="md:col-span-3"><label for="serologias_notas" class="block text-sm font-medium text-gray-700">Notas de Serologías</label><textarea id="serologias_notas" name="serologias_notas" class="form-input mt-1" rows="2"></textarea></div>
                        </div>
                    </details>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div><label for="grupo_materno" class="block text-sm font-medium text-gray-700">Grupo Materno</label><select id="grupo_materno" name="grupo_materno" class="form-input mt-1"><option value="">Seleccionar...</option><option value="A">A</option><option value="B">B</option><option value="AB">AB</option><option value="0">0</option></select></div>
                        <div><label for="rh_materno" class="block text-sm font-medium text-gray-700">Rh Materno</label><select id="rh_materno" name="rh_materno" class="form-input mt-1"><option value="">Seleccionar...</option><option value="+">+</option><option value="-">-</option></select></div>
                        <div><label for="grupo_paciente" class="block text-sm font-medium text-gray-700">Grupo Paciente</label><select id="grupo_paciente" name="grupo_paciente" class="form-input mt-1"><option value="">Seleccionar...</option><option value="A">A</option><option value="B">B</option><option value="AB">AB</option><option value="0">0</option></select></div>
                        <div><label for="rh_paciente" class="block text-sm font-medium text-gray-700">Rh Paciente</label><select id="rh_paciente" name="rh_paciente" class="form-input mt-1"><option value="">Seleccionar...</option><option value="+">+</option><option value="-">-</option></select></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-2">
                        <div><label for="pcd" class="block text-sm font-medium text-gray-700">PCD</label><select id="pcd" name="pcd" class="form-input mt-1"><option value="">Seleccionar...</option><option value="negativo">Negativo</option><option value="positivo">Positivo</option></select></div>
                        <div><label for="pci" class="block text-sm font-medium text-gray-700">PCI</label><select id="pci" name="pci" class="form-input mt-1"><option value="">Seleccionar...</option><option value="negativo">Negativo</option><option value="positivo">Positivo</option></select></div>
                    </div>

                    <details>
                        <summary>Antecedentes Patológicos</summary>
                        <div class="pt-4">
                            <label for="antPatologicos" class="block text-sm font-medium text-gray-700">Selección de Antecedentes (múltiple)</label>
                            <select id="antPatologicos" name="antPatologicos" class="form-input mt-1" multiple size="6">
                                <option value="ninguno">Ninguno</option><option value="hta">HTA</option><option value="dbt">DBT</option><option value="dbt_gestacional">DBT gestacional</option><option value="hipotiroidismo">Hipotiroidismo</option><option value="hipertiroidismo">Hipertiroidismo</option><option value="infeccion_urinaria">Infección Urinaria</option><option value="consumo_problematico">Consumo Problemático</option><option value="otras">Otras</option>
                            </select>
                            <small class="text-gray-500">Ctrl + Click para seleccionar varios.</small>
                        </div>
                    </details>
                    
                    <hr>
                    <h3 class="text-lg font-semibold title-text border-b pb-2">Condiciones del Parto</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="tipo_nacimiento" class="block text-sm font-medium text-gray-700">Tipo de Nacimiento</label>
                            <select id="tipo_nacimiento" name="tipo_nacimiento" class="form-input mt-1">
                                <option value="">Seleccionar...</option><option value="parto">Parto</option><option value="cesarea">Cesárea</option>
                            </select>
                        </div>
                         <div>
                            <label for="presentacion" class="block text-sm font-medium text-gray-700">Presentación</label>
                            <select id="presentacion" name="presentacion" class="form-input mt-1">
                                <option value="">Seleccionar...</option><option value="cefalica">Cefálica</option><option value="transversa">Transversa</option>
                                <option value="podalica">Podálica</option>
                            </select>
                        </div>
                        <div>
                            <label for="membranas" class="block text-sm font-medium text-gray-700">Membranas</label>
                            <select id="membranas" name="membranas" class="form-input mt-1">
                                <option value="">Seleccionar...</option><option value="rotura_espontanea">Rotura espontánea</option><option value="rotura_artificial">Rotura artificial</option><option value="rotura_prematura">Rotura prematura</option>
                            </select>
                        </div>
                        <div>
                            <label for="liquido_amniotico" class="block text-sm font-medium text-gray-700">Líquido Amniótico</label>
                            <select id="liquido_amniotico" name="liquido_amniotico" class="form-input mt-1">
                                <option value="">Seleccionar...</option><option value="claro">Claro</option><option value="meconial">Meconial</option>
                                <option value="sanguinolento">Sanguinolento</option>
                            </select>
                        </div>
                        <div>
                            <label for="evolucion" class="block text-sm font-medium text-gray-700">Evolución</label>
                            <select id="evolucion" name="evolucion" class="form-input mt-1">
                                <option value="">Seleccionar...</option><option value="internacion_conjunta">Internación conjunta</option><option value="utin">UTIN</option><option value="obito">Óbito</option>
                            </select>
                        </div>
                    </div>
                    
                    <hr>
                    <h3 class="text-lg font-semibold title-text border-b pb-2">Datos del Recién Nacido</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="peso" class="block text-sm font-medium text-gray-700">Peso (gr)</label><input type="number" id="peso" name="peso" class="form-input mt-1" min="0"></div>
                        <div class="grid grid-cols-2 gap-6">
                            <div><label for="talla" class="block text-sm font-medium text-gray-700">Talla (cm)</label><input type="number" id="talla" name="talla" class="form-input mt-1" min="0" step="0.1"></div>
                            <div><label for="pc" class="block text-sm font-medium text-gray-700">PC (cm)</label><input type="number" id="pc" name="pc" class="form-input mt-1" min="0" step="0.1"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="eg" class="block text-sm font-medium text-gray-700">EG (semanas)</label><input type="number" id="eg" name="eg" class="form-input mt-1" min="20" max="45"></div>
                        <div class="grid grid-cols-2 gap-6">
                            <div><label for="apgar1" class="block text-sm font-medium text-gray-700">Apgar 1</label><input type="number" id="apgar1" name="apgar1" class="form-input mt-1" min="0" max="10"></div>
                            <div><label for="apgar5" class="block text-sm font-medium text-gray-700">Apgar 5</label><input type="number" id="apgar5" name="apgar5" class="form-input mt-1" min="0" max="10"></div>
                        </div>
                    </div>
                    
                    <hr>
                    <details>
                        <summary>Diagnóstico</summary>
                        <div class="pt-4">
                            <label for="diagnostico" class="block text-sm font-medium text-gray-700">Selección de Diagnósticos (múltiple)</label>
                            <select id="diagnostico" name="diagnostico" class="form-input mt-1" multiple size="6">
                                <option value="rnt_paeg">RNT-PAEG</option><option value="rnt_apeg">RNT-APEG</option><option value="rnt_bpeg">RNT-BPEG</option><option value="rnpt_paeg">RNPT-PAEG</option><option value="rnpt_bpeg">RNPT-BPEG</option><option value="rnpt_apeg">RNPT-APEG</option><option value="rnpost_paeg">RNPOST-PAEG</option><option value="rnpost_bpeg">RNPOST-BPEG</option><option value="rnpost_apeg">RNPOST-APEG</option><option value="asfixia">Asfixia neonatal</option><option value="dif_respiratoria">Dif. respiratoria</option><option value="causa_social">Causa Social</option><option value="hijo_madre_consumo">Hijo de madre con consumo problemático</option><option value="otros">Otros</option>
                            </select>
                            <small class="text-gray-500">Ctrl + Click para seleccionar varios.</small>
                        </div>
        
                        <div id="diagnostico_otros_wrapper" class="hidden mt-4">
                            <label for="diagnostico_otros" class="block text-sm font-medium text-gray-700">Otros Diagnósticos</label>
                            <input type="text" id="diagnostico_otros" name="diagnostico_otros" class="form-input mt-1">
                        </div>
                    </details>

                    <hr>
                    <h3 class="text-lg font-semibold title-text border-b pb-2">Notas Adicionales</h3>
                    <div>
                        <label for="notas" class="block text-sm font-medium text-gray-700">Notas</label>
                        <textarea id="notas" name="notas" class="form-input mt-1" rows="4"></textarea>
                    </div>

                    <div class="pt-4 text-right">
                        <button type="submit" class="btn-primary">Guardar Paciente</button>
                    </div>
                </form>
            </div>
            
            <div id="consultas-view" class="p-8 bg-white shadow-lg rounded-b-lg hidden">
                <div class="bg-blue-50 p-6 rounded-lg shadow-inner mb-8 border border-blue-200">
                    <h2 class="text-2xl font-semibold title-text mb-6">Consultas y Reportes</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold title-text">Filtrar Pacientes</h3>
                            <div><label for="search-apellido" class="block text-sm font-medium text-gray-700">Apellido</label><input type="text" id="search-apellido" class="form-input mt-1" placeholder="Buscar por apellido..."></div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div><label for="search-fecha-desde" class="block text-sm font-medium text-gray-700">Nacido desde</label><input type="date" id="search-fecha-desde" class="form-input mt-1"></div>
                                <div><label for="search-fecha-hasta" class="block text-sm font-medium text-gray-700">Nacido hasta</label><input type="date" id="search-fecha-hasta" class="form-input mt-1"></div>
                            </div>
                            <div class="flex gap-4 pt-2">
                                <button id="search-button" class="btn-primary flex-1">Buscar</button>
                                <button id="clear-search-button" class="btn-secondary flex-1">Limpiar</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                            <div>
                                <h3 class="text-lg font-semibold title-text mb-3">Exportar</h3>
                                <div class="flex flex-col sm:flex-row gap-4">
                                    <button id="export-filtered-button" class="btn-secondary text-sm">CSV (Filtrados)</button>
                                    <button id="export-all-button" class="btn-secondary text-sm">CSV (Todos)</button>
                                </div>
                            </div>
                            <div class="text-right">
                                 <h3 class="text-lg font-semibold title-text mb-3">Nacimientos (Mes)</h3>
                                 <p class="text-4xl font-bold text-blue-600">
                                    <span id="total-nacimientos">0</span>
                                 </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="default-results-notice" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4" role="alert">
                    <p class="font-bold">Aviso:</p>
                    <p class="text-sm">Se muestran los 3 pacientes más recientes. Utilice los filtros para realizar una búsqueda específica.</p>
                </div>

                <h2 class="text-xl font-semibold title-text mb-4">Resultados</h2>
                
                <div class="md:hidden bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-3 mb-4 text-sm" role="alert">
                    <p class="font-semibold">Información:</p>
                    <p>Desplácese horizontalmente en la tabla para ver los botones de acción (Editar, Compartir, Borrar).</p>
                </div>
                
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Apellido</th>
                                <th class="p-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nombre</th>
                                <th class="p-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Fecha Nac.</th>
                                <th class="p-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Diagnóstico</th>
                                <th class="p-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="pacientes-tbody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <div id="dashboard-view" class="bg-white shadow-lg rounded-b-lg hidden p-4 sm:p-8">
                
                <div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-6 border-b pb-4 gap-4">
                    <div>
                        <h2 class="text-2xl font-semibold title-text">Tablero Estadístico</h2>
                        <p class="text-gray-500 text-sm mt-1">Análisis por periodo.</p>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-3">
                        <select id="dash-year" class="dash-select"></select>
                        <select id="dash-month" class="dash-select">
                            <option value="all">Todo el año</option>
                            <option value="0">Enero</option>
                            <option value="1">Febrero</option>
                            <option value="2">Marzo</option>
                            <option value="3">Abril</option>
                            <option value="4">Mayo</option>
                            <option value="5">Junio</option>
                            <option value="6">Julio</option>
                            <option value="7">Agosto</option>
                            <option value="8">Septiembre</option>
                            <option value="9">Octubre</option>
                            <option value="10">Noviembre</option>
                            <option value="11">Diciembre</option>
                        </select>
                        <button id="refresh-dashboard" class="btn-primary text-sm flex items-center gap-2 px-3 py-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
                    <div class="dash-card border-l-4 border-blue-500">
                        <span class="dash-stat-label">Total (Periodo Seleccionado)</span>
                        <span class="dash-stat-value" id="kpi-total">0</span>
                    </div>
                    <div class="dash-card border-l-4 border-purple-500">
                        <span class="dash-stat-label">% Cesáreas</span>
                        <span class="dash-stat-value" id="kpi-cesarea">0%</span>
                    </div>
                    <div class="dash-card border-l-4 border-orange-500">
                        <span class="dash-stat-label">Promedio Edad Gestacional</span>
                        <span class="dash-stat-value" id="kpi-eg-avg">0 sem</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <div class="dash-card">
                        <h3 class="text-lg font-bold text-gray-700 mb-4 text-center">Evolución / Destino del RN</h3>
                        <div class="relative w-full h-64 flex justify-center">
                            <canvas id="chart-evolution-rn"></canvas>
                        </div>
                    </div>

                    <div class="dash-card">
                        <h3 class="text-lg font-bold text-gray-700 mb-4 text-center">Tipo de Nacimiento</h3>
                        <div class="relative w-full h-64 flex justify-center">
                            <canvas id="chart-type"></canvas>
                        </div>
                    </div>

                    <div class="dash-card">
                        <h3 class="text-lg font-bold text-gray-700 mb-4 text-center">Término vs Pretérmino</h3>
                        <div class="relative w-full h-64 flex justify-center">
                            <canvas id="chart-term"></canvas>
                        </div>
                        <p class="text-xs text-gray-400 mt-2 text-center">*Pretérmino: < 37 semanas</p>
                    </div>

                    <div class="dash-card">
                        <h3 class="text-lg font-bold text-gray-700 mb-4 text-center">Control Prenatal</h3>
                        <div class="relative w-full h-64 flex justify-center">
                            <canvas id="chart-control"></canvas>
                        </div>
                    </div>

                </div>
            </div>

        </main>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <header class="flex justify-between items-center p-6 border-b">
                <h2 class="text-2xl font-semibold title-text">Editar Paciente</h2>
                <button id="close-edit-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </header>
            <form id="edit-form" class="p-8 space-y-6">
                <input type="hidden" name="id_paciente_edit">
                
                <h3 class="text-lg font-semibold title-text border-b pb-2">Datos del Paciente</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div><label for="edit-apellido" class="block text-sm font-medium text-gray-700">Apellido</label><input type="text" id="edit-apellido" name="apellido" class="form-input mt-1" required></div>
                    <div><label for="edit-nombre" class="block text-sm font-medium text-gray-700">Nombre</label><input type="text" id="edit-nombre" name="nombre" class="form-input mt-1" required></div>
                    <div><label for="edit-fecha_nacimiento" class="block text-sm font-medium text-gray-700">Fecha de Nacimiento</label><input type="date" id="edit-fecha_nacimiento" name="fecha_nacimiento" class="form-input mt-1" required></div>
                    <div><label for="edit-hora_nacimiento" class="block text-sm font-medium text-gray-700">Hora Nac.</label><input type="time" id="edit-hora_nacimiento" name="hora_nacimiento" class="form-input mt-1" required></div>
                </div>
                
                <hr>
                <h3 class="text-lg font-semibold title-text border-b pb-2">Datos Maternos</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div><label for="edit-edad_materna" class="block text-sm font-medium text-gray-700">Edad Materna</label><input type="number" id="edit-edad_materna" name="edad_materna" class="form-input mt-1" min="10"></div>
                    <div><label for="edit-g" class="block text-sm font-medium text-gray-700">G</label><input type="number" id="edit-g" name="g" class="form-input mt-1" min="0" max="15"></div>
                    <div><label for="edit-p" class="block text-sm font-medium text-gray-700">P</label><input type="number" id="edit-p" name="p" class="form-input mt-1" min="0" max="15"></div>
                    <div><label for="edit-a" class="block text-sm font-medium text-gray-700">A</label><input type="number" id="edit-a" name="a" class="form-input mt-1" min="0" max="15"></div>
                </div>
                
                <div class="grid grid-cols-1 gap-6 items-center">
                    <div class="flex flex-wrap items-center gap-x-6 gap-y-2">
                        <div class="flex items-center space-x-4">
                            <label for="edit-controlada" class="block text-sm font-medium text-gray-700">Controlada</label>
                            <label class="switch"><input type="checkbox" id="edit-controlada" name="controlada"><span class="slider"></span></label>
                        </div>
                        <div class="flex-1 min-w-[150px]">
                            <label for="edit-num_controles" class="block text-sm font-medium text-gray-700">N° de Controles</label>
                            <input type="number" id="edit-num_controles" name="num_controles" class="form-input mt-1" min="0" max="99">
                        </div>
                    </div>
                </div>

                <details id="edit-serologias-details">
                    <summary>Serologías Maternas</summary>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div><label class="block text-sm font-medium text-gray-700">VDRL</label><div class="grid grid-cols-3 gap-2 mt-1"><input type="date" name="vdrl_fecha" class="form-input col-span-2"><select name="vdrl_resultado" class="form-input"><option value="-">-</option><option value="+">+</option></select></div></div>
                        <div><label class="block text-sm font-medium text-gray-700">HIV</label><div class="grid grid-cols-3 gap-2 mt-1"><input type="date" name="hiv_fecha" class="form-input col-span-2"><select name="hiv_resultado" class="form-input"><option value="-">-</option><option value="+">+</option></select></div></div>
                        <div><label class="block text-sm font-medium text-gray-700">Chagas</label><div class="grid grid-cols-3 gap-2 mt-1"><input type="date" name="chagas_fecha" class="form-input col-span-2"><select name="chagas_resultado" class="form-input"><option value="-">-</option><option value="+">+</option></select></div></div>
                        <div><label class="block text-sm font-medium text-gray-700">HBV</label><div class="grid grid-cols-3 gap-2 mt-1"><input type="date" name="hbv_fecha" class="form-input col-span-2"><select name="hbv_resultado" class="form-input"><option value="-">-</option><option value="+">+</option></select></div></div>
                        <div><label class="block text-sm font-medium text-gray-700">Toxoplasmosis</label><div class="grid grid-cols-3 gap-2 mt-1"><input type="date" name="toxo_fecha" class="form-input col-span-2"><select name="toxo_resultado" class="form-input"><option value="-">-</option><option value="+">+</option></select></div></div>
                        <div><label class="block text-sm font-medium text-gray-700">CMV</label><div class="grid grid-cols-3 gap-2 mt-1"><input type="date" name="cmv_fecha" class="form-input col-span-2"><select name="cmv_resultado" class="form-input"><option value="-">-</option><option value="+">+</option></select></div></div>
                        <div class="md:col-span-3"><label for="edit-serologias_notas" class="block text-sm font-medium text-gray-700">Notas de Serologías</label><textarea id="edit-serologias_notas" name="serologias_notas" class="form-input mt-1" rows="2"></textarea></div>
                    </div>
                </details>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div><label for="edit-grupo_materno" class="block text-sm font-medium text-gray-700">Grupo Materno</label><select id="edit-grupo_materno" name="grupo_materno" class="form-input mt-1"><option value="">Seleccionar...</option><option value="A">A</option><option value="B">B</option><option value="AB">AB</option><option value="0">0</option></select></div>
                    <div><label for="edit-rh_materno" class="block text-sm font-medium text-gray-700">Rh Materno</label><select id="edit-rh_materno" name="rh_materno" class="form-input mt-1"><option value="">Seleccionar...</option><option value="+">+</option><option value="-">-</option></select></div>
                    <div><label for="edit-grupo_paciente" class="block text-sm font-medium text-gray-700">Grupo Paciente</label><select id="edit-grupo_paciente" name="grupo_paciente" class="form-input mt-1"><option value="">Seleccionar...</option><option value="A">A</option><option value="B">B</option><option value="AB">AB</option><option value="0">0</option></select></div>
                    <div><label for="edit-rh_paciente" class="block text-sm font-medium text-gray-700">Rh Paciente</label><select id="edit-rh_paciente" name="rh_paciente" class="form-input mt-1"><option value="">Seleccionar...</option><option value="+">+</option><option value="-">-</option></select></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-2">
                    <div><label for="edit-pcd" class="block text-sm font-medium text-gray-700">PCD</label><select id="edit-pcd" name="pcd" class="form-input mt-1"><option value="">Seleccionar...</option><option value="negativo">Negativo</option><option value="positivo">Positivo</option></select></div>
                    <div><label for="edit-pci" class="block text-sm font-medium text-gray-700">PCI</label><select id="edit-pci" name="pci" class="form-input mt-1"><option value="">Seleccionar...</option><option value="negativo">Negativo</option><option value="positivo">Positivo</option></select></div>
                </div>

                <details id="edit-antpatologicos-details">
                    <summary>Antecedentes Patológicos</summary>
                    <div class="pt-4">
                        <label for="edit-antPatologicos" class="block text-sm font-medium text-gray-700">Selección de Antecedentes (múltiple)</label>
                        <select id="edit-antPatologicos" name="antPatologicos" class="form-input mt-1" multiple size="6">
                            <option value="ninguno">Ninguno</option><option value="hta">HTA</option><option value="dbt">DBT</option><option value="dbt_gestacional">DBT gestacional</option><option value="hipotiroidismo">Hipotiroidismo</option><option value="hipertiroidismo">Hipertiroidismo</option><option value="infeccion_urinaria">Infección Urinaria</option><option value="consumo_problematico">Consumo Problemático</option><option value="otras">Otras</option>
                        </select>
                        <small class="text-gray-500">Ctrl + Click para seleccionar varios.</small>
                    </div>
                </details>
                
                <hr>
                <h3 class="text-lg font-semibold title-text border-b pb-2">Condiciones del Parto</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="edit-tipo_nacimiento" class="block text-sm font-medium text-gray-700">Tipo de Nacimiento</label>
                        <select id="edit-tipo_nacimiento" name="tipo_nacimiento" class="form-input mt-1">
                            <option value="">Seleccionar...</option><option value="parto">Parto</option><option value="cesarea">Cesárea</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-presentacion" class="block text-sm font-medium text-gray-700">Presentación</label>
                        <select id="edit-presentacion" name="presentacion" class="form-input mt-1">
                            <option value="">Seleccionar...</option><option value="cefalica">Cefálica</option><option value="transversa">Transversa</option>
                            <option value="podalica">Podálica</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-membranas" class="block text-sm font-medium text-gray-700">Membranas</label>
                        <select id="edit-membranas" name="membranas" class="form-input mt-1">
                            <option value="">Seleccionar...</option><option value="rotura_espontanea">Rotura espontánea</option><option value="rotura_artificial">Rotura artificial</option><option value="rotura_prematura">Rotura prematura</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-liquido_amniotico" class="block text-sm font-medium text-gray-700">Líquido Amniótico</label>
                        <select id="edit-liquido_amniotico" name="liquido_amniotico" class="form-input mt-1">
                            <option value="">Seleccionar...</option><option value="claro">Claro</option><option value="meconial">Meconial</option>
                            <option value="sanguinolento">Sanguinolento</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-evolucion" class="block text-sm font-medium text-gray-700">Evolución</label>
                        <select id="edit-evolucion" name="evolucion" class="form-input mt-1">
                            <option value="">Seleccionar...</option><option value="internacion_conjunta">Internación conjunta</option><option value="utin">UTIN</option><option value="obito">Óbito</option>
                        </select>
                    </div>
                </div>
                
                <hr>
                <h3 class="text-lg font-semibold title-text border-b pb-2">Datos del Recién Nacido</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label for="edit-peso" class="block text-sm font-medium text-gray-700">Peso (gr)</label><input type="number" id="edit-peso" name="peso" class="form-input mt-1" min="0"></div>
                    <div class="grid grid-cols-2 gap-6">
                        <div><label for="edit-talla" class="block text-sm font-medium text-gray-700">Talla (cm)</label><input type="number" id="edit-talla" name="talla" class="form-input mt-1" min="0" step="0.1"></div>
                        <div><label for="edit-pc" class="block text-sm font-medium text-gray-700">PC (cm)</label><input type="number" id="edit-pc" name="pc" class="form-input mt-1" min="0" step="0.1"></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label for="edit-eg" class="block text-sm font-medium text-gray-700">EG (semanas)</label><input type="number" id="edit-eg" name="eg" class="form-input mt-1" min="20" max="45"></div>
                    <div class="grid grid-cols-2 gap-6">
                        <div><label for="edit-apgar1" class="block text-sm font-medium text-gray-700">Apgar 1</label><input type="number" id="edit-apgar1" name="apgar1" class="form-input mt-1" min="0" max="10"></div>
                        <div><label for="edit-apgar5" class="block text-sm font-medium text-gray-700">Apgar 5</label><input type="number" id="edit-apgar5" name="apgar5" class="form-input mt-1" min="0" max="10"></div>
                    </div>
                </div>
                
                <hr>
                <details id="edit-diagnostico-details">
                    <summary>Diagnóstico</summary>
                    <div class="pt-4">
                        <label for="edit-diagnostico" class="block text-sm font-medium text-gray-700">Selección de Diagnósticos (múltiple)</label>
                        <select id="edit-diagnostico" name="diagnostico" class="form-input mt-1" multiple size="6">
                            <option value="rnt_paeg">RNT-PAEG</option><option value="rnt_apeg">RNT-APEG</option><option value="rnt_bpeg">RNT-BPEG</option><option value="rnpt_paeg">RNPT-PAEG</option><option value="rnpt_bpeg">RNPT-BPEG</option><option value="rnpt-apeg">RNPT-APEG</option><option value="rnpost_paeg">RNPOST-PAEG</option><option value="rnpost_bpeg">RNPOST-BPEG</option><option value="rnpost_apeg">RNPOST-APEG</option><option value="asfixia">Asfixia neonatal</option><option value="dif_respiratoria">Dif. respiratoria</option><option value="causa_social">Causa Social</option><option value="hijo_madre_consumo">Hijo de madre con consumo problemático</option><option value="otros">Otros</option>
                        </select>
                        <small class="text-gray-500">Ctrl + Click para seleccionar varios.</small>
                    </div>
    
                    <div id="edit-diagnostico_otros_wrapper" class="hidden mt-4">
                        <label for="edit-diagnostico_otros" class="block text-sm font-medium text-gray-700">Otros Diagnósticos</label>
                        <input type="text" id="edit-diagnostico_otros" name="diagnostico_otros" class="form-input mt-1">
                    </div>
                </details>

                <hr>
                <h3 class="text-lg font-semibold title-text border-b pb-2">Notas Adicionales</h3>
                <div>
                    <label for="edit-notas" class="block text-sm font-medium text-gray-700">Notas</label>
                    <textarea id="edit-notas" name="notas" class="form-input mt-1" rows="4"></textarea>
                </div>

                <footer class="flex justify-end gap-4 pt-4">
                    <button type="button" class="btn-secondary" id="cancel-edit-button">Cerrar</button>
                    <button type="submit" class="btn-primary" id="save-edit-button">Guardar Cambios</button>
                </footer>
            </form>
        </div>
    </div>
    
    <div id="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // CONFIGURACION FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyCmuO4U_fDthWu_vY-ghx9marNtF78_vzM",
          authDomain: "nacimientos2.firebaseapp.com",
          projectId: "nacimientos2",
          storageBucket: "nacimientos2.firebasestorage.app",
          messagingSenderId: "228024131760",
          appId: "1:228024131760:web:8159300ab19043453d9b75"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let allPatients = []; 
        const patientsCollection = collection(db, "pacientes");
        const auditLogsCollection = collection(db, "logs_borrado");
        let patientsListenerUnsubscribe = null; 
        
        // Variables para Gráficos
        let chartEvolutionRN = null; // Renombrado
        let chartType = null;
        let chartTerm = null;
        let chartControl = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Referencias DOM
            const loginView = document.getElementById('login-view');
            const appView = document.getElementById('app-view');
            const loadingView = document.getElementById('loading-view');
            const userEmailDisplay = document.getElementById('user-email');
            
            // Navegación
            const tabs = {
                ingreso: document.getElementById('tab-ingreso'),
                consultas: document.getElementById('tab-consultas'),
                dashboard: document.getElementById('tab-dashboard')
            };
            const views = {
                ingreso: document.getElementById('ingreso-view'),
                consultas: document.getElementById('consultas-view'),
                dashboard: document.getElementById('dashboard-view')
            };
            
            // Referencias para el Modal de Edición
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-form');
            const closeEditModalButton = document.getElementById('close-edit-modal');
            const cancelEditButton = document.getElementById('cancel-edit-button');
            const saveEditButton = document.getElementById('save-edit-button');
            let currentEditPatientId = null;

            closeEditModalButton.addEventListener('click', () => editModal.classList.add('hidden'));
            cancelEditButton.addEventListener('click', () => editModal.classList.add('hidden'));

            // Dashboard Inputs
            const dashYearSelect = document.getElementById('dash-year');
            const dashMonthSelect = document.getElementById('dash-month');
            const refreshDashboardBtn = document.getElementById('refresh-dashboard');

            // Forms y Botones
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const ingresoForm = document.getElementById('ingreso-form');
            const searchButton = document.getElementById('search-button');
            const clearSearchButton = document.getElementById('clear-search-button');

            // --- UTILITIES ---

            function formatDate(str) {
                if(!str) return '-';
                const [y, m, d] = str.split('-');
                return `${d}/${m}/${y}`;
            }

            const capitalize = (s) => s ? s.charAt(0).toUpperCase() + s.slice(1) : '';

            // --- AUTENTICACION ---
            onAuthStateChanged(auth, (user) => {
                loadingView.classList.add('hidden');
                if (user) {
                    currentUser = user;
                    userEmailDisplay.textContent = user.email;
                    loginView.classList.add('hidden');
                    appView.classList.remove('hidden');
                    setupRealtimeListener();
                } else {
                    currentUser = null;
                    allPatients = [];
                    loginView.classList.remove('hidden');
                    appView.classList.add('hidden');
                }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    await signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value);
                    showToast('Bienvenido', 'success');
                } catch (error) { showToast(error.message, 'error'); }
            });

            document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
            
            document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); });
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); signupForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    await createUserWithEmailAndPassword(auth, e.target['signup-email'].value, e.target['signup-password'].value);
                    showToast('Cuenta creada', 'success');
                } catch (error) { showToast(error.message, 'error'); }
            });

            // --- NAVEGACION ---
            function switchTab(target) {
                Object.values(views).forEach(v => v.classList.add('hidden'));
                Object.values(tabs).forEach(t => {
                    t.classList.remove('active');
                    t.classList.add('inactive');
                });

                views[target].classList.remove('hidden');
                tabs[target].classList.add('active');
                tabs[target].classList.remove('inactive');

                if (target === 'consultas') updateTableDefault();
                if (target === 'dashboard') {
                    // Si no hay años cargados, cargarlos
                    if (dashYearSelect.options.length === 0) populateYearFilter();
                    updateDashboard();
                }
            }

            tabs.ingreso.addEventListener('click', () => switchTab('ingreso'));
            tabs.consultas.addEventListener('click', () => switchTab('consultas'));
            tabs.dashboard.addEventListener('click', () => switchTab('dashboard'));

            // --- LOGICA DE DATOS ---
            function setupRealtimeListener() {
                if (patientsListenerUnsubscribe) patientsListenerUnsubscribe();
                patientsListenerUnsubscribe = onSnapshot(patientsCollection, (snapshot) => {
                    allPatients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Ordenar por fecha nacimiento descendente
                    allPatients.sort((a, b) => {
                        const dateA = new Date(a.fecha_nacimiento || 0);
                        const dateB = new Date(b.fecha_nacimiento || 0);
                        return dateB - dateA;
                    });

                    document.getElementById('total-nacimientos').textContent = countCurrentMonthBirths(allPatients);
                    
                    if (!views.dashboard.classList.contains('hidden')) {
                        populateYearFilter(); // Recargar años si entran nuevos datos
                        updateDashboard();
                    }
                    if (!views.consultas.classList.contains('hidden')) updateTableDefault();

                }, (error) => console.error(error));
            }

            function countCurrentMonthBirths(patients) {
                const now = new Date();
                return patients.filter(p => {
                    if (!p.fecha_nacimiento) return false;
                    const d = new Date(p.fecha_nacimiento + "T00:00:00");
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                }).length;
            }
            
            // Función para mostrar/ocultar el aviso de resultados por defecto
            function toggleDefaultNotice(show) {
                const notice = document.getElementById('default-results-notice');
                if (notice) {
                    if (show) {
                        notice.classList.remove('hidden');
                    } else {
                        notice.classList.add('hidden');
                    }
                }
            }

            // --- DASHBOARD LOGIC (MEJORADA) ---

            function populateYearFilter() {
                const years = new Set();
                const currentYear = new Date().getFullYear();
                years.add(currentYear); // Asegurar que el año actual está
                
                allPatients.forEach(p => {
                    if(p.fecha_nacimiento) {
                        years.add(new Date(p.fecha_nacimiento).getFullYear());
                    }
                });

                const sortedYears = Array.from(years).sort((a,b) => b-a);
                const currentVal = dashYearSelect.value;
                
                dashYearSelect.innerHTML = '';
                sortedYears.forEach(y => {
                    const opt = document.createElement('option');
                    opt.value = y;
                    opt.textContent = y;
                    dashYearSelect.appendChild(opt);
                });

                // Mantener selección o default
                if(sortedYears.includes(parseInt(currentVal))) {
                    dashYearSelect.value = currentVal;
                } else {
                    dashYearSelect.value = currentYear;
                }
            }

            function updateDashboard() {
                const selectedYear = parseInt(dashYearSelect.value);
                const selectedMonth = dashMonthSelect.value; // 'all' or '0'-'11'
                
                // 1. FILTRAR DATOS
                const filteredData = allPatients.filter(p => {
                    if (!p.fecha_nacimiento) return false;
                    const d = new Date(p.fecha_nacimiento + "T00:00:00");
                    
                    const matchYear = d.getFullYear() === selectedYear;
                    let matchMonth = true;
                    if(selectedMonth !== 'all') {
                        matchMonth = d.getMonth() === parseInt(selectedMonth);
                    }
                    return matchYear && matchMonth;
                });

                // 2. KPIS
                const total = filteredData.length;
                
                // Cesáreas
                const cesareas = filteredData.filter(p => p.tipo_nacimiento === 'cesarea').length;
                const cesareaPct = total > 0 ? Math.round((cesareas / total) * 100) : 0;

                // Promedio Edad Gestacional (Reemplaza a Peso)
                const egs = filteredData.map(p => parseFloat(p.eg)).filter(e => !isNaN(e) && e > 0);
                const avgEg = egs.length > 0 ? (egs.reduce((a, b) => a + b, 0) / egs.length).toFixed(1) : 0;

                document.getElementById('kpi-total').textContent = total;
                document.getElementById('kpi-cesarea').textContent = `${cesareaPct}%`;
                document.getElementById('kpi-eg-avg').textContent = `${avgEg} sem`;

                // 3. RENDER CHARTS
                renderDestinoChart(filteredData); // NUEVO
                renderDistributionCharts(filteredData);
            }

            // Gráfico EVOLUCION / DESTINO (NUEVO)
            function renderDestinoChart(data) {
                const ctx = document.getElementById('chart-evolution-rn').getContext('2d');
                
                let counts = {
                    'internacion_conjunta': 0,
                    'utin': 0,
                    'obito': 0
                };

                data.forEach(p => {
                    if(p.evolucion && counts.hasOwnProperty(p.evolucion)) {
                        counts[p.evolucion]++;
                    }
                });

                if (chartEvolutionRN) chartEvolutionRN.destroy();
                chartEvolutionRN = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Internación Conjunta', 'UTIN', 'Óbito'],
                        datasets: [{
                            label: 'Cantidad',
                            data: [counts['internacion_conjunta'], counts['utin'], counts['obito']],
                            backgroundColor: [
                                '#10b981', // Verde para conjunta
                                '#f59e0b', // Naranja para UTIN
                                '#ef4444'  // Rojo para Obito
                            ],
                            borderRadius: 4
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }, // Ocultar leyenda porque los ejes ya explican
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                        }
                    }
                });
            }

            function renderDistributionCharts(data) {
                // --- Chart 2: Tipo Nacimiento ---
                const types = { 'parto': 0, 'cesarea': 0 };
                data.forEach(p => {
                    if(p.tipo_nacimiento === 'parto') types['parto']++;
                    else if(p.tipo_nacimiento === 'cesarea') types['cesarea']++;
                });

                const ctxType = document.getElementById('chart-type').getContext('2d');
                if (chartType) chartType.destroy();
                chartType = new Chart(ctxType, {
                    type: 'doughnut',
                    data: {
                        labels: ['Parto Vaginal', 'Cesárea'],
                        datasets: [{
                            data: [types['parto'], types['cesarea']],
                            backgroundColor: ['#10b981', '#f97316']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // --- Chart 3: Término vs Pretérmino ---
                let termino = 0, preterm = 0;
                data.forEach(p => {
                    const eg = parseFloat(p.eg);
                    if(eg) {
                        if(eg < 37) preterm++;
                        else termino++;
                    }
                });

                const ctxTerm = document.getElementById('chart-term').getContext('2d');
                if (chartTerm) chartTerm.destroy();
                chartTerm = new Chart(ctxTerm, {
                    type: 'pie',
                    data: {
                        labels: ['Término (>=37s)', 'Pretérmino (<37s)'],
                        datasets: [{
                            data: [termino, preterm],
                            backgroundColor: ['#6366f1', '#ef4444']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // --- Chart 4: Controlada ---
                let si = 0, no = 0;
                data.forEach(p => {
                   if(p.controlada) si++; else no++;
                });
                
                const ctxControl = document.getElementById('chart-control').getContext('2d');
                if (chartControl) chartControl.destroy();
                chartControl = new Chart(ctxControl, {
                    type: 'pie',
                    data: {
                        labels: ['Controlada', 'No Controlada'],
                        datasets: [{
                            data: [si, no],
                            backgroundColor: ['#0ea5e9', '#94a3b8']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
            
            // Listeners para filtros
            dashYearSelect.addEventListener('change', updateDashboard);
            dashMonthSelect.addEventListener('change', updateDashboard);
            refreshDashboardBtn.addEventListener('click', () => {
                updateDashboard();
                showToast("Dashboard actualizado", "success");
            });

            // --- INGRESO ---
            ingresoForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) return showToast('Debes iniciar sesión', 'error');

                const btn = ingresoForm.querySelector('button[type="submit"]');
                btn.disabled = true; btn.textContent = 'Guardando...';

                try {
                    const formData = new FormData(ingresoForm);
                    const data = Object.fromEntries(formData.entries());
                    
                    data.controlada = document.getElementById('controlada').checked;
                    data.diagnostico = Array.from(document.getElementById('diagnostico').selectedOptions).map(o => o.value);
                    data.antPatologicos = Array.from(document.getElementById('antPatologicos').selectedOptions).map(o => o.value);
                    
                    data.createdAt = Timestamp.now();
                    data.createdBy = currentUser.email;

                    await addDoc(patientsCollection, data);
                    showToast('Guardado correctamente', 'success');
                    ingresoForm.reset();
                    document.querySelectorAll('details').forEach(d => d.open = false);
                } catch (err) {
                    console.error(err);
                    showToast('Error al guardar', 'error');
                } finally {
                    btn.disabled = false; btn.textContent = 'Guardar Paciente';
                }
            });

            document.getElementById('diagnostico').addEventListener('change', (e) => {
                const vals = Array.from(e.target.selectedOptions).map(o => o.value);
                const wrap = document.getElementById('diagnostico_otros_wrapper');
                const input = document.getElementById('diagnostico_otros');
                if(vals.includes('otros')) { wrap.classList.remove('hidden'); input.required = true; }
                else { wrap.classList.add('hidden'); input.required = false; }
            });

            // --- CONSULTAS ---
            function updateTableDefault() {
                // Muestra solo los 3 pacientes más recientes
                renderTable(allPatients.slice(0, 3));
                toggleDefaultNotice(true);
            }

            searchButton.addEventListener('click', () => {
                const apellido = document.getElementById('search-apellido').value.toLowerCase();
                const fDesde = document.getElementById('search-fecha-desde').value;
                const fHasta = document.getElementById('search-fecha-hasta').value;

                let filtered = allPatients.filter(p => {
                    let match = true;
                    if(apellido && (!p.apellido || !p.apellido.toLowerCase().includes(apellido))) match = false;
                    if(fDesde && p.fecha_nacimiento < fDesde) match = false;
                    if(fHasta && p.fecha_nacimiento > fHasta) match = false;
                    return match;
                });
                renderTable(filtered);
                
                // Oculta el aviso si se usan filtros
                if (apellido || fDesde || fHasta) {
                    toggleDefaultNotice(false);
                } else {
                    toggleDefaultNotice(true);
                }
            });

            document.getElementById('clear-search-button').addEventListener('click', () => {
                document.getElementById('search-apellido').value = '';
                document.getElementById('search-fecha-desde').value = '';
                document.getElementById('search-fecha-hasta').value = '';
                updateTableDefault(); // Muestra los últimos 3 y el aviso
            });

            function renderTable(data) {
                const tbody = document.getElementById('pacientes-tbody');
                tbody.innerHTML = '';
                if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">No hay datos</td></tr>'; return; }

                data.forEach(p => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 border-b';
                    row.innerHTML = `
                        <td class="p-4">${p.apellido || ''}</td>
                        <td class="p-4">${p.nombre || ''}</td>
                        <td class="p-4">${formatDate(p.fecha_nacimiento)}</td>
                        <td class="p-4 text-sm text-gray-500 truncate max-w-xs">${p.diagnostico ? p.diagnostico.join(', ') : ''}</td>
                        <td class="p-4 text-right flex justify-end gap-2">
                            <button class="btn-edit" onclick="window.editPatient('${p.id}')">Ver / Editar</button>
                            <button class="btn-share" onclick="window.sharePatient('${p.id}')">Compartir</button>
                            <button class="btn-danger" onclick="window.deletePatient('${p.id}')">Borrar</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            // --- FUNCIONES DE ACCION DE TABLA ---

            window.sharePatient = (id) => {
                const patient = allPatients.find(p => p.id === id);
                if (!patient) return showToast('Paciente no encontrado', 'error');

                // Internal helpers for formatting the shared text
                const formatSerology = (date, result, label) => {
                    if (date || result === '+' || result === '-') {
                        const dateStr = date ? ` (${formatDate(date)})` : '';
                        const resultStr = result || 'N/E';
                        return `  - ${label}: ${resultStr}${dateStr}`;
                    }
                    return '';
                };

                const formatList = (arr, label) => {
                    if (arr && arr.length > 0 && !(arr.length === 1 && arr[0] === 'ninguno')) {
                        // Reemplazar underscores y capitalizar
                        const list = arr.map(s => capitalize(s.replace(/_/g, ' '))).join(', ');
                        return `${label}: ${list}`;
                    }
                    return '';
                };
                
                const formatField = (label, value) => value ? `${label}: ${value}` : '';
                const formatBlock = (label, value) => value ? `${label}:\n${value}` : '';


                let shareText = `\n=================================\n`;
                shareText += `= FICHA DE REGISTRO DE NACIMIENTO =\n`;
                shareText += `=================================\n\n`;

                // ** I. DATOS DEL PACIENTE **
                shareText += `** I. DATOS DEL PACIENTE **\n`;
                shareText += formatField('» Paciente', `${patient.apellido || ''}, ${patient.nombre || ''}\n`);
                shareText += formatField('» Nacimiento', `${formatDate(patient.fecha_nacimiento)} ${patient.hora_nacimiento || ''}\n`);
                shareText += formatField('» Peso/Talla/PC', `${patient.peso || ''} gr / ${patient.talla || ''} cm / ${patient.pc || ''} cm\n`);
                shareText += formatField('» EG', `${patient.eg || ''} semanas\n`);
                shareText += formatField('» Apgar 1/5', `${patient.apgar1 || ''} / ${patient.apgar5 || ''}\n`);
                shareText += formatField('» Grupo/Rh Paciente', `${patient.grupo_paciente || '?'}${patient.rh_paciente || '?'}\n`);
                shareText += formatField('» PCD/PCI', `${capitalize(patient.pcd)} / ${capitalize(patient.pci)}\n`);
                
                // ** II. DATOS MATERNOS **
                shareText += `\n** II. DATOS MATERNOS **\n`;
                shareText += formatField('» Edad Materna', `${patient.edad_materna || ''} años\n`);
                shareText += formatField('» Fórmula Obstétrica (G/P/A)', `${patient.g || ''} / ${patient.p || ''} / ${patient.a || ''}\n`);
                shareText += formatField('» Control Prenatal (N°)', `${patient.controlada ? 'Sí' : 'No'} (${patient.num_controles || 0} controles)\n`);
                shareText += formatField('» Grupo/Rh Materno', `${patient.grupo_materno || '?'}${patient.rh_materno || '?'}\n`);
                
                const antPatologicosList = formatList(patient.antPatologicos, '» Ant. Patológicos');
                shareText += antPatologicosList ? `${antPatologicosList}\n` : '';

                // Serologías Detalladas
                shareText += `\n* Serologías Maternas:\n`;
                let seroContent = '';
                seroContent += formatSerology(patient.vdrl_fecha, patient.vdrl_resultado, 'VDRL') + '\n';
                seroContent += formatSerology(patient.hiv_fecha, patient.hiv_resultado, 'HIV') + '\n';
                seroContent += formatSerology(patient.chagas_fecha, patient.chagas_resultado, 'Chagas') + '\n';
                seroContent += formatSerology(patient.hbv_fecha, patient.hbv_resultado, 'HBV') + '\n';
                seroContent += formatSerology(patient.toxo_fecha, patient.toxo_resultado, 'Toxoplasmosis') + '\n';
                seroContent += formatSerology(patient.cmv_fecha, patient.cmv_resultado, 'CMV') + '\n';
                shareText += seroContent.trim() || '  - Ninguna serología con resultados/fechas registradas.\n';

                if (patient.serologias_notas) {
                    shareText += `\n${formatField('  - Notas Serológicas', patient.serologias_notas)}\n`;
                }

                // ** III. CONDICIONES DEL PARTO **
                shareText += `\n** III. CONDICIONES DEL PARTO **\n`;
                shareText += formatField('» Tipo Nacimiento', capitalize(patient.tipo_nacimiento));
                shareText += formatField('» Presentación', capitalize(patient.presentacion));
                shareText += formatField('» Membranas', capitalize(patient.membranas));
                shareText += formatField('» Líquido Amniótico', capitalize(patient.liquido_amniotico));
                shareText += formatField('» Evolución (Destino)', capitalize(patient.evolucion));
                
                // ** IV. DIAGNÓSTICO Y NOTAS **
                shareText += `\n** IV. DIAGNÓSTICO Y NOTAS **\n`;
                const diagnosticoList = formatList(patient.diagnostico, '» Diagnósticos');
                shareText += diagnosticoList ? `${diagnosticoList}\n` : '';
                shareText += formatField('» Otros Diagnósticos', patient.diagnostico_otros);
                shareText += formatBlock('» Notas Adicionales', patient.notas);
                
                shareText += `\n\n=================================\n`;
                
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(shareText)
                        .then(() => showToast('Ficha copiada al portapapeles', 'success'))
                        .catch(err => {
                             console.error("Error al copiar al portapapeles:", err);
                             showToast('Error al copiar: Su navegador no permite esta acción. Intente de forma manual.', 'error');
                        });
                } else {
                    // Fallback para navegadores antiguos
                    const textarea = document.createElement('textarea');
                    textarea.value = shareText;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        showToast('Ficha copiada al portapapeles (Fallback)', 'success');
                    } catch (err) {
                        showToast('Error al copiar al portapapeles', 'error');
                    }
                    document.body.removeChild(textarea);
                }
            };
            
            window.editPatient = (id) => {
                const patient = allPatients.find(p => p.id === id);
                if (!patient) return showToast('Paciente no encontrado', 'error');

                currentEditPatientId = id;
                
                // Función auxiliar para setear valores
                const setVal = (selector, value) => {
                    const el = editForm.querySelector(`[name="${selector}"]`);
                    if (el) el.value = value || '';
                };
                const setChecked = (selector, value) => {
                    const el = editForm.querySelector(`[name="${selector}"]`);
                    if (el) el.checked = !!value;
                };
                
                // Resetear opciones múltiples
                editForm.querySelectorAll('select[multiple] option').forEach(opt => opt.selected = false);
                editForm.querySelectorAll('details').forEach(d => d.open = false);
                
                // --- Datos Paciente ---
                setVal('apellido', patient.apellido);
                setVal('nombre', patient.nombre);
                setVal('fecha_nacimiento', patient.fecha_nacimiento);
                setVal('hora_nacimiento', patient.hora_nacimiento);
                
                // --- Datos Maternos ---
                setVal('edad_materna', patient.edad_materna);
                setVal('g', patient.g);
                setVal('p', patient.p);
                setVal('a', patient.a);
                setChecked('controlada', patient.controlada);
                setVal('num_controles', patient.num_controles);

                // Serologías
                setVal('vdrl_fecha', patient.vdrl_fecha); setVal('vdrl_resultado', patient.vdrl_resultado);
                setVal('hiv_fecha', patient.hiv_fecha); setVal('hiv_resultado', patient.hiv_resultado);
                setVal('chagas_fecha', patient.chagas_fecha); setVal('chagas_resultado', patient.chagas_resultado);
                setVal('hbv_fecha', patient.hbv_fecha); setVal('hbv_resultado', patient.hbv_resultado);
                setVal('toxo_fecha', patient.toxo_fecha); setVal('toxo_resultado', patient.toxo_resultado);
                setVal('cmv_fecha', patient.cmv_fecha); setVal('cmv_resultado', patient.cmv_resultado);
                setVal('serologias_notas', patient.serologias_notas);
                if (patient.serologias_notas || patient.vdrl_fecha || patient.hiv_fecha || patient.chagas_fecha || patient.hbv_fecha || patient.toxo_fecha || patient.cmv_fecha) {
                     editForm.querySelector('#edit-serologias-details').open = true;
                }
                
                // Grupos y Rh
                setVal('grupo_materno', patient.grupo_materno);
                setVal('rh_materno', patient.rh_materno);
                setVal('grupo_paciente', patient.grupo_paciente);
                setVal('rh_paciente', patient.rh_paciente);
                setVal('pcd', patient.pcd);
                setVal('pci', patient.pci);

                // Antecedentes Patológicos (Multiple Select)
                const antPatologicosSelect = editForm.querySelector('#edit-antPatologicos');
                if (patient.antPatologicos && Array.isArray(patient.antPatologicos)) {
                    patient.antPatologicos.forEach(val => {
                        const opt = antPatologicosSelect.querySelector(`option[value="${val}"]`);
                        if (opt) opt.selected = true;
                    });
                     editForm.querySelector('#edit-antpatologicos-details').open = patient.antPatologicos.length > 0 && patient.antPatologicos[0] !== 'ninguno';
                }


                // --- Condiciones Parto ---
                setVal('tipo_nacimiento', patient.tipo_nacimiento);
                setVal('presentacion', patient.presentacion);
                setVal('membranas', patient.membranas);
                setVal('liquido_amniotico', patient.liquido_amniotico);
                setVal('evolucion', patient.evolucion);

                // --- Datos Recién Nacido ---
                setVal('peso', patient.peso);
                setVal('talla', patient.talla);
                setVal('pc', patient.pc);
                setVal('eg', patient.eg);
                setVal('apgar1', patient.apgar1);
                setVal('apgar5', patient.apgar5);

                // Diagnóstico (Multiple Select)
                const diagSelect = editForm.querySelector('#edit-diagnostico');
                const otrosWrap = document.getElementById('edit-diagnostico_otros_wrapper');
                const otrosInput = document.getElementById('edit-diagnostico_otros');
                let hasOtros = false;
                
                if (patient.diagnostico && Array.isArray(patient.diagnostico)) {
                    patient.diagnostico.forEach(val => {
                        if (val === 'otros') hasOtros = true;
                        const opt = diagSelect.querySelector(`option[value="${val}"]`);
                        if (opt) opt.selected = true;
                    });
                    editForm.querySelector('#edit-diagnostico-details').open = patient.diagnostico.length > 0;
                }
                
                // Mostrar/Ocultar "Otros Diagnósticos"
                if(hasOtros || patient.diagnostico_otros) {
                    otrosWrap.classList.remove('hidden');
                    otrosInput.required = true;
                    setVal('diagnostico_otros', patient.diagnostico_otros);
                } else {
                    otrosWrap.classList.add('hidden');
                    otrosInput.required = false;
                    otrosInput.value = '';
                }
                
                // --- Notas ---
                setVal('notas', patient.notas);

                editModal.classList.remove('hidden');
            };

            // Listener para 'otros' en el modal de edición
            editForm.querySelector('#edit-diagnostico').addEventListener('change', (e) => {
                const vals = Array.from(e.target.selectedOptions).map(o => o.value);
                const wrap = document.getElementById('edit-diagnostico_otros_wrapper');
                const input = document.getElementById('edit-diagnostico_otros');
                if(vals.includes('otros')) { wrap.classList.remove('hidden'); input.required = true; }
                else { wrap.classList.add('hidden'); input.required = false; }
            });

            // Handler para guardar cambios del formulario completo
            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentEditPatientId) return;

                saveEditButton.disabled = true; saveEditButton.textContent = 'Guardando...';

                try {
                    const docRef = doc(db, "pacientes", currentEditPatientId);
                    
                    const formData = new FormData(editForm);
                    const dataToUpdate = Object.fromEntries(formData.entries());
                    
                    // Manejar campos especiales: controlada (boolean) y selects múltiples (arrays)
                    dataToUpdate.controlada = editForm.querySelector('input[name="controlada"]').checked;
                    
                    const antPatologicosSelect = editForm.querySelector('#edit-antPatologicos');
                    dataToUpdate.antPatologicos = Array.from(antPatologicosSelect.selectedOptions).map(o => o.value);

                    const diagnosticoSelect = editForm.querySelector('#edit-diagnostico');
                    dataToUpdate.diagnostico = Array.from(diagnosticoSelect.selectedOptions).map(o => o.value);
                    
                    dataToUpdate.updatedAt = Timestamp.now();
                    
                    // Limpiar campos que no deben ser guardados si están vacíos o no seleccionados
                    if (!dataToUpdate.diagnostico_otros) delete dataToUpdate.diagnostico_otros;
                    
                    // Asegurar que los campos numéricos se guarden como número o string vacío/cero, si es necesario. Firestore maneja esto bien en general.
                    
                    await updateDoc(docRef, dataToUpdate);
                    showToast('Paciente actualizado', 'success');
                    editModal.classList.add('hidden');

                } catch (err) {
                    console.error(err);
                    showToast('Error al actualizar', 'error');
                } finally {
                    saveEditButton.disabled = false; saveEditButton.textContent = 'Guardar Cambios';
                }
            });

            
            window.deletePatient = async (id) => {
                if(!confirm("¿Borrar paciente?")) return;
                try {
                    await deleteDoc(doc(db, "pacientes", id));
                    showToast("Borrado", "success");
                } catch(e) { showToast("Error al borrar", "error"); }
            };
            
            function showToast(msg, type) {
                const t = document.getElementById('toast');
                t.textContent = msg; t.className = type; t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            }
            
            switchTab('ingreso');
        });
    </script>
</body>
</html>
